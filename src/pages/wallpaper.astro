---
import '@/styles/global.css'
import { Font } from 'astro:assets'
import { IPHONE_MODELS } from '@/features/controls'
import { DEVICE_DPR, DOWNSAMPLING_FACTOR, DraggableWrapper } from '@/features/preview'
import { CalendarDisplay } from '@/features/widgets/calendar'
import { DaysLeftDisplay } from '@/features/widgets/days-left'
import { PhraseDisplay } from '@/features/widgets/phrase'
import { decodeConfig } from '@/lib/config'
import dayjs from '@/lib/dayjs'

export const prerender = false

const configParam = Astro.url.searchParams.get('config')
if (!configParam) {
	return new Response('Missing config parameter', { status: 400 })
}

const config = decodeConfig(configParam)
if (!config) {
	return new Response('Invalid config', { status: 400 })
}

const model = IPHONE_MODELS[config.model]
let width = model.width / DEVICE_DPR
let height = model.height / DEVICE_DPR

const headerHeight = Astro.request.headers.get('X-Height')
const headerWidth = Astro.request.headers.get('X-Width')

if (headerHeight && headerWidth) {
	const parsedWidth = Number.parseInt(headerWidth, 10)
	const parsedHeight = Number.parseInt(headerHeight, 10)

	if (!Number.isNaN(parsedWidth) && !Number.isNaN(height) && parsedWidth > 0 && parsedHeight > 0) {
		width = parsedWidth
		height = parsedHeight
	}
}

width = width * DOWNSAMPLING_FACTOR
height = height * DOWNSAMPLING_FACTOR

// Get user timezone from Vercel geolocation header (e.g., "Asia/Tokyo", "America/New_York")
const timezone = Astro.request.headers.get('X-Vercel-IP-Timezone')
const now = timezone ? dayjs().tz(timezone) : dayjs()
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>一日一歩</title>
		<Font cssVariable="--font-zen" preload />
    <style define:vars={{ width, height }}>
			@media print {
				@page {
					margin: 0;
					padding: 0;
				}
			}

			html, body {
				background: black;
			}

			#wallpaper {
        width: calc(var(--width) * 1px);
        height: calc(var(--height) * 1px);
				box-shadow: 0 0 0 100dvh inset black;
			}
		</style>
	</head>
	<body>
		<div
			id="wallpaper"
			class="relative overflow-hidden bg-black font-apple dark"
		>
			{config.phrase.enabled && (
				<DraggableWrapper yOffsetPercent={config.offsets.phrase}>
					<PhraseDisplay
						mode={config.phrase.mode}
						mainLang={config.phrase.mainLang}
						subtextMode={config.phrase.subtextMode}
						subtextLang={config.phrase.subtextLang}
						customText={config.phrase.customText}
						customSubtext={config.phrase.customSubtext}
					/>
				</DraggableWrapper>
			)}

			{config.calendar.enabled && (
				<DraggableWrapper yOffsetPercent={config.offsets.calendar}>
					<CalendarDisplay
						now={now}
						timeMode={config.calendar.timeMode}
						showLabel={config.calendar.showLabel}
						labelLang={config.calendar.labelLang}
						dotStyle={config.calendar.dotStyle}
						weekStart={config.calendar.weekStart}
					/>
				</DraggableWrapper>
			)}

			{config.daysLeft.enabled && (
				<DraggableWrapper yOffsetPercent={config.offsets.daysLeft}>
					<DaysLeftDisplay
						now={now}
						mode={config.daysLeft.mode}
						dateMode={config.daysLeft.dateMode}
						weekStart={config.daysLeft.weekStart}
					/>
				</DraggableWrapper>
			)}
		</div>
	</body>
</html>
